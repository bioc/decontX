---
title: "Decontamination of single cell protein expression data with DecontPro"
author:
- name: Yuan Yin
  affiliation: &id Boston University School of Medicine
- name: Joshua Campbell
  affiliation: *id
  email: camp@bu.edu
date: "`r Sys.Date()`"
output: 
  BiocStyle::html_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{decontPro}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Introduction

DecontPro assess and decontaminate single-cell protein expression data, such as 
those generated from CITE-seq or Total-seq. The count matrix is decomposed into 
three matrices, the native, the ambient and the background that represent the 
contribution from the true protein expression on cells, the ambient material and
other non-specific background contamination.

The package can be loaded using the `library` command.

```{r load, eval=TRUE, message=FALSE}
library(decontX)
```

# Importing data

```{r eval=FALSE}
library(DropletUtils)
sce_filtered <- read10xCounts('filtered_feature_bc_matrix')
adt_filtered <- sce_filtered[rowData(sce_filtered)$Type == 'Antibody Capture',]
```

You may clean the imported data after importing. For example, remove droplets with outlier library sizes.

# Generate cell clusters

`decontPro` requires a vector indicating the cell types of each droplet. Here we use `Seurat` for clustering.

```{r eval=FALSE}
library(Seurat)
library(dplyr)
adt_seurat <- CreateSeuratObject(counts(adt_filtered), assay = 'ADT')
adt_seurat <- NormalizeData(adt_seurat, normalization.method = "CLR", margin = 2) %>%
  ScaleData(assay = "ADT") %>%
  RunPCA(assay = "ADT", features = rownames(adt_seurat),
  reduction.name = "pca_adt", npcs = 10) %>%
  FindNeighbors(dims = 1:10, assay = "ADT", reduction = "pca_adt") %>%
  FindClusters(resolution = 0.2)
  
clusters = as.integer(Idents(adt_seurat))
```


# Run DecontPro

```{r eval=FALSE}
counts <- as.matrix(counts(adt_filtered))
out <- decontPro(counts, clusters)
```

The output contains three matrices, and model parameters after inference. 
`decontaminated_counts` represent the true protein expression on cells.

```{r eval = FALSE}
decontaminated_counts <- out$decontaminated_counts
```


# Session Information

```{r}
sessionInfo()
```
